{% extends "base.html" %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-3">
        <div class="card text-center h-100">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-5">
                <div class="position-relative mb-3">
                    <img src="{{ current_user.avatar }}" class="rounded-circle border border-4 border-white shadow-sm" width="100" height="100">
                    <span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle p-2"></span>
                </div>
                <h5 class="fw-bold mb-1">{{ current_user.username }}</h5>
                <span class="badge bg-primary bg-opacity-10 text-primary mb-4">认证卖家</span>
                
                <div class="w-100 border-top pt-4 mt-2">
                    <div class="row text-center">
                        <div class="col">
                            <h4 class="fw-bold mb-0">{{ products|length }}</h4>
                            <small class="text-muted">在售</small>
                        </div>
                        <div class="col border-start">
                            <h4 class="fw-bold mb-0">¥{{ sales }}</h4>
                            <small class="text-muted">收益</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold m-0">商品管理</h4>
                <p class="text-muted small m-0">管理您的库存与订单</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('seller.orders') }}" class="btn btn-outline-primary rounded-pill px-4 position-relative">
                    <i class="bi bi-bag me-2"></i>订单管理
                    {% if pending_orders > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ pending_orders }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('seller.my_messages') }}" class="btn btn-outline-info rounded-pill px-4 position-relative">
                    <i class="bi bi-chat-dots me-2"></i>消息中心
                    {% if unread_messages > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ unread_messages }}</span>
                    {% endif %}
                </a>
                <button type="button" class="btn btn-dark rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#publishModal">
                    <i class="bi bi-plus-lg me-2"></i>发布商品
                </button>
            </div>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" style="min-width: 700px;">
                    <thead class="bg-light">
                        <tr class="text-muted small text-uppercase">
                            <th class="ps-4 py-3">商品信息</th>
                            <th>分类</th>
                            <th>价格</th>
                            <th>状态</th>
                            <th class="text-end pe-4">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in products %}
                        <tr id="product-row-{{ p.id }}">
                            <td class="ps-4 py-3">
                                <div class="d-flex align-items-center">
                                    <img src="{{ p.image_url }}" class="rounded-3 me-3" width="48" height="48" style="object-fit: cover;">
                                    <div>
                                        <div class="fw-bold text-dark">{{ p.title }}</div>
                                        <div class="small text-muted text-truncate" style="max-width: 150px;">{{ p.attributes.get('desc', '') }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border fw-normal">{{ p.category }}</span>
                            </td>
                            <td>
                                <span class="fw-bold" id="price-{{ p.id }}">¥ {{ p.price }}</span>
                            </td>
                            <td>
                                <span id="status-badge-{{ p.id }}">
                                {% if p.status == 0 %}<span class="badge bg-secondary bg-opacity-10 text-secondary">已下架</span>
                                {% elif p.status == 1 %}<span class="badge bg-success bg-opacity-10 text-success">销售中</span>
                                {% elif p.status == 2 %}<span class="badge bg-warning bg-opacity-10 text-warning">已预订</span>
                                {% elif p.status == 3 %}<span class="badge bg-secondary bg-opacity-10 text-secondary">已售罄</span>
                                {% endif %}
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group btn-group-sm">
                                    {% if p.status in [0, 1] %}
                                    <button class="btn btn-outline-primary" onclick="showPriceModal({{ p.id }}, {{ p.price }})">
                                        <i class="bi bi-tag"></i>
                                    </button>
                                    <a href="{{ url_for('seller.edit_product', product_id=p.id) }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% if p.status == 1 %}
                                    <button class="btn btn-outline-warning" onclick="toggleProductStatus({{ p.id }})">
                                        <i class="bi bi-eye-slash"></i>
                                    </button>
                                    {% elif p.status == 0 %}
                                    <button class="btn btn-outline-success" onclick="toggleProductStatus({{ p.id }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-danger" onclick="deleteProduct({{ p.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% else %}
                                    <a href="{{ url_for('buyer.product_detail', product_id=p.id) }}" class="btn btn-outline-secondary">
                                        查看
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-box-seam fs-1 d-block mb-3 opacity-25"></i>
                                暂无商品，快去发布吧
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 发布商品模态框 -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">发布新商品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form method="post">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">标题</label>
                        {{ form.title(class="form-control bg-light border-0", placeholder="例如：99新 iPad Air 5") }}
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label small fw-bold text-muted">价格</label>
                            {{ form.price(class="form-control bg-light border-0") }}
                        </div>
                        <div class="col">
                            <label class="form-label small fw-bold text-muted">分类</label>
                            {{ form.category(class="form-select bg-light border-0") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">图片链接</label>
                        {{ form.image_url(class="form-control bg-light border-0", placeholder="https://...") }}
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted">描述</label>
                        {{ form.desc(class="form-control bg-light border-0", rows=3) }}
                    </div>
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary rounded-pill py-2") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 改价模态框 -->
<div class="modal fade" id="priceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-tag"></i> 修改价格
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="priceForm" onsubmit="updatePrice(event)">
                    <input type="hidden" id="productIdForPrice" value="">
                    <div class="mb-3">
                        <label class="form-label">当前价格</label>
                        <input type="text" class="form-control" id="currentPrice" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新价格</label>
                        <input type="number" 
                               class="form-control" 
                               id="newPrice"
                               step="0.01"
                               min="0.01"
                               required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">确认修改</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 显示改价模态框
function showPriceModal(productId, currentPrice) {
    document.getElementById('productIdForPrice').value = productId;
    document.getElementById('currentPrice').value = '¥ ' + currentPrice;
    document.getElementById('newPrice').value = currentPrice;
    const modal = new bootstrap.Modal(document.getElementById('priceModal'));
    modal.show();
}

// 更新价格
function updatePrice(event) {
    event.preventDefault();
    const productId = document.getElementById('productIdForPrice').value;
    const newPrice = document.getElementById('newPrice').value;
    
    if (!newPrice || parseFloat(newPrice) <= 0) {
        alert('请输入有效的价格');
        return;
    }
    
    fetch(`/seller/update_price/${productId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({price: newPrice})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById(`price-${productId}`).textContent = '¥ ' + data.new_price;
            const modal = bootstrap.Modal.getInstance(document.getElementById('priceModal'));
            modal.hide();
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('操作失败');
    });
}

// 切换商品状态（上架/下架）
function toggleProductStatus(productId) {
    fetch(`/seller/toggle_product_status/${productId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('操作失败');
    });
}

// 删除商品
function deleteProduct(productId) {
    if (!confirm('确定要删除这个商品吗？此操作不可恢复！')) {
        return;
    }
    
    fetch(`/seller/delete_product/${productId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById(`product-row-${productId}`).remove();
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('删除失败');
    });
}
</script>
{% endblock %}
